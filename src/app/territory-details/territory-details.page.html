<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start" *ngIf="user?.territoryNumber == ''" >
      <ion-back-button defaultHref="/note-no-one-home"></ion-back-button>
    </ion-buttons>
    <ion-title>Território {{ territory?.territoryName }} - {{ territory?.territoryNumber }}</ion-title>
    <ion-buttons slot="end">
      <ion-button color="medium" (click)="logout()">
        <ion-icon slot="start" [icon]="logOutIcon"></ion-icon>
        Sair
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>
  <ng-container *ngIf="!loading; else loadingTpl">
    <!-- Territory Map Image -->
    <div class="territory-image" *ngIf="territory?.territoryMapPath" (click)="openMapModal()">
      <img [src]="territory.territoryMapPath" alt="Mapa do Território {{ territory?.territoryName }}" />
    </div>

    <!-- Warning Messages -->
    <div *ngIf="warningMessage" class="warning-message">
      {{ warningMessage }}
    </div>

    <!-- Labels -->
    <div class="labels">
      <p><strong>Designado para:</strong> {{ assignedTo || '' }}</p>
      <p><strong>Data de designação:</strong> 
        <span *ngIf="assignmentDate; else noDate">
          {{ assignmentDate | date:'dd/MM/yyyy' }} - {{ daysSinceAssignment }} dia(s)
        </span>
        <ng-template #noDate></ng-template>
      </p>
      <!-- Generate link button shown only when assignment date exists and territory not completed -->
      <div *ngIf="showLinkAvailable && !territory?.completedDate" class="link-actions">
        <ion-button size="small" color="tertiary" (click)="generateLinkForTerritory()" [disabled]="isGeneratingLink">
          <ion-spinner *ngIf="isGeneratingLink" slot="start" name="crescent"></ion-spinner>
          {{ isGeneratingLink ? 'Gerando...' : 'Gerar link' }}
        </ion-button>
      </div>
      <div *ngIf="generatedLink" class="generated-link">
        <ion-item>
          <ion-textarea [value]="generatedLink" readonly auto-grow rows="2"></ion-textarea>
          <ion-button slot="end" (click)="copyGeneratedLink()" [disabled]="linkCopied">{{ linkCopied ? 'Copiado' : 'Copiar' }}</ion-button>
        </ion-item>
        <ion-note *ngIf="linkCopied" color="success">Link copiado para a área de transferência.</ion-note>
      </div>
    </div>

    <!-- Dashboard -->
    <div class="dashboard">
      <ion-card>
        <ion-card-content>
          <ion-list>
            <ion-item>
              <ion-label><strong>Casas do território:</strong></ion-label>
              <ion-note slot="end">{{ totalHouses }}</ion-note>
            </ion-item>
            <ion-item>
              <ion-label><strong>Casas faladas:</strong></ion-label>
              <ion-note slot="end">{{ visitedHouses }} ({{ visitedPercentage }}%)</ion-note>
            </ion-item>
            <ion-item>
              <ion-label><strong>Não em casa:</strong></ion-label>
              <ion-note slot="end">{{ noOneHomeHouses }} ({{ noOneHomePercentage }}%)</ion-note>
            </ion-item>
          </ion-list>
        </ion-card-content>
      </ion-card>
    </div>

    <!-- Block Grid -->
    <h2 style="text-align: center; margin-top: 16px;">Selecione uma quadra</h2>
    <ion-grid>
      <ion-row>
        <ion-col size="4" *ngFor="let block of blocks">
          <ion-card (click)="selectBlock(block)" class="square-card">
            <ion-card-content>
              <div class="block-text">{{ block.name }}</div>
            </ion-card-content>
          </ion-card>
        </ion-col>
      </ion-row>
    </ion-grid>
  </ng-container>

  <ng-template #loadingTpl>
    <div class="spinner-wrap">
      <ion-spinner name="crescent"></ion-spinner>
    </div>
  </ng-template>

  <!-- Map Modal -->
  <ion-modal [isOpen]="isMapModalOpen" (ionModalDidDismiss)="closeMapModal()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-buttons slot="end">
            <ion-button (click)="closeMapModal()">Fechar</ion-button>
          </ion-buttons>
          <ion-title>Mapa do Território</ion-title>
        </ion-toolbar>
      </ion-header>
      <ion-content>
        <div class="modal-map" #mapContainer>
          <img
            [src]="territory?.territoryMapPath"
            alt="Mapa do Território {{ territory?.name }}"
            class="zoomable-map"
            #mapImage
          />
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-content>
